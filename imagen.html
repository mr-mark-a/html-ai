<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Imagen 3.0 Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 600px;
        }
        .card {
            background-color: #161b22;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .btn-primary {
            background-color: #238636;
            transition: background-color 0.15s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #2ea043;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #c9d1d9;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <div class="card p-6 md:p-8 rounded-xl">
            <h1 class="text-3xl font-bold mb-2 text-white flex items-center">
                <!-- Image Icon (Lucide Icon Placeholder) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-400"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                Imagen 3.0 AI Art Studio
            </h1>
            <p class="text-gray-400 mb-6">Enter a creative prompt to generate a stunning, unique image using the Imagen model. Optionally upload an image for image-to-image generation. <strong>Note: Add your Google API key in the script.</strong></p>

            <!-- Image Upload -->
            <div class="mb-4">
                <label for="imageInput" class="block text-sm font-medium text-gray-300 mb-2">Upload Reference Image (optional)</label>
                <input type="file" id="imageInput" accept="image/*" class="w-full p-3 rounded-lg bg-[#0d1117] border border-gray-700 text-white focus:ring-green-500 focus:border-green-500 transition-colors">
                <div id="imagePreview" class="mt-2 hidden">
                    <img id="previewImg" class="w-full max-h-48 object-cover rounded-lg">
                </div>
            </div>

            <!-- Prompt Input -->
            <textarea id="promptInput" rows="3" class="w-full p-3 mb-4 rounded-lg bg-[#0d1117] border border-gray-700 text-white focus:ring-green-500 focus:border-green-500 transition-colors" placeholder="e.g., A majestic lion wearing a space helmet, digital art, high detail, 4k"></textarea>

            <!-- Controls -->
            <button id="generateButton" onclick="generateImage()" class="btn-primary w-full text-white font-semibold py-3 rounded-lg flex items-center justify-center disabled:opacity-50 transition duration-150">
                <span id="buttonText">Generate Image</span>
                <span id="loadingIndicator" class="hidden spinner ml-3"></span>
            </button>
            <p id="errorBox" class="text-red-400 mt-3 text-sm hidden"></p>
        </div>

        <!-- Result Section -->
        <div id="resultContainer" class="mt-8">
            <h2 class="text-xl font-semibold mb-3 text-white">Generated Image</h2>
            <div id="imagePlaceholder" class="w-full aspect-square bg-[#161b22] rounded-xl flex items-center justify-center border-2 border-dashed border-gray-700">
                <p class="text-gray-500">Your generated image will appear here.</p>
            </div>
        </div>
    </div>

    <script>
        // Add your Google API key here
        const apiKey = "YOUR_GOOGLE_API_KEY_HERE"; // Replace with your actual API key
        const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict';

        const promptInput = document.getElementById('promptInput');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorBox = document.getElementById('errorBox');
        const resultContainer = document.getElementById('resultContainer');
        const imagePlaceholder = document.getElementById('imagePlaceholder');

        let uploadedImageBase64 = null;

        // Handle image upload
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    uploadedImageBase64 = event.target.result.split(',')[1]; // Get base64 data
                    previewImg.src = event.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                uploadedImageBase64 = null;
                imagePreview.classList.add('hidden');
            }
        });

        // Utility for exponential backoff during API calls
        async function fetchWithExponentialBackoff(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return await response.json();
                    }
                    
                    // If not OK, but not a rate limit error, throw
                    if (response.status !== 429 && response.status !== 500) {
                        const errorBody = await response.json();
                        throw new Error(`API Error ${response.status}: ${errorBody.error?.message || 'Unknown error'}`);
                    }

                    // Handle rate limit (429) or internal server error (500) with retry
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    console.warn(`Request failed with status ${response.status}. Retrying in ${delay / 1000}s... (Attempt ${attempt + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, delay));

                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    console.error(`An error occurred: ${error.message}. Retrying in ${delay / 1000}s... (Attempt ${attempt + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error('Failed to fetch after multiple retries.');
        }

        function setUIState(isLoading) {
            generateButton.disabled = isLoading;
            promptInput.disabled = isLoading;
            imageInput.disabled = isLoading;
            loadingIndicator.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Generating...' : 'Generate Image';
            errorBox.classList.add('hidden');
            errorBox.textContent = '';
            
            // Clear previous result on new generation
            if (isLoading) {
                imagePlaceholder.innerHTML = '<p class="text-gray-500">Your generated image will appear here.</p>';
            }
        }

        async function generateImage() {
            const prompt = promptInput.value.trim();
            if (!prompt && !uploadedImageBase64) {
                errorBox.textContent = 'Please enter a prompt or upload an image.';
                errorBox.classList.remove('hidden');
                return;
            }

            if (!apiKey || apiKey === "YOUR_GOOGLE_API_KEY_HERE") {
                errorBox.textContent = 'Please add your Google API key in the script.';
                errorBox.classList.remove('hidden');
                return;
            }

            setUIState(true);

            try {
                // Construct the payload for the Imagen API
                const instance = { prompt: prompt };
                if (uploadedImageBase64) {
                    instance.image = { bytesBase64Encoded: uploadedImageBase64 };
                }
                const payload = {
                    instances: [instance],
                    parameters: { 
                        "sampleCount": 1,
                        "aspectRatio": "1:1", // Default to square for mobile-friendliness
                        "numberOfImages": 1
                    }
                };

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                const fullUrl = `${apiUrl}?key=${apiKey}`;
                
                const result = await fetchWithExponentialBackoff(fullUrl, options);
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    const imageUrl = `data:image/png;base64,${base64Data}`;

                    // Create the image element
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = prompt;
                    img.className = 'w-full h-auto rounded-xl object-cover';
                    
                    // Replace placeholder content with the generated image
                    imagePlaceholder.innerHTML = '';
                    imagePlaceholder.classList.remove('border-dashed');
                    imagePlaceholder.classList.add('aspect-auto');
                    imagePlaceholder.appendChild(img);

                } else {
                    throw new Error("API response was successful but contained no valid image data.");
                }

            } catch (error) {
                console.error("Image generation failed:", error);
                errorBox.textContent = `Error: ${error.message || 'Image generation failed. Please try a different prompt.'}`;
                errorBox.classList.remove('hidden');
                imagePlaceholder.innerHTML = '<p class="text-red-400">Failed to generate image.</p>';
                imagePlaceholder.classList.add('border-dashed');
            } finally {
                setUIState(false);
            }
        }

        // Initialize with a default prompt hint
        window.onload = function() {
            promptInput.value = "A modern city with flying cats";
        };
    </script>
</body>
</html>